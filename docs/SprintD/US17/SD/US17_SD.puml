@startuml US17_SD
autonumber

actor "Center Coordinator" as COORDINATOR

participant ":CoordinatorUI" as CUI
participant ":ImportLegacyDataUI" as UI
participant ":App" as _APP
participant "app:App" as APP
participant ":ImportLegacyDataController" as CTRL
participant "empSess:employeeSession" as SESSION
participant "comp:Company" as COMPANY
participant "csvReader:CSVReader" as CSVREADER
participant ":ICSVReader" as ICSV
participant ":LegacyDataMapper" as MAPPER
participant "legacyDataDto:LegacyDataDTO" as DTO
participant "legacyDtoList:List<LegacyDataDTO>" as LIST_DTOS
participant "snsUserStore:SNSUserStore" as SNSSTORE
participant "center:VaccinationCenter" as CENTER
participant "fileData:List<String[]>" as LIST_FILEDATA

activate COORDINATOR
  ref over COORDINATOR
    ' !include ../../CoordinatorLogin_SD.puml!
    ' ![[../../CoordinatorLogin_SD.puml]]
    ' ![[../../CoordinatorLogin_SD.svg]]
    CoordinatorLogin_SD
  end ref

  activate CUI
  COORDINATOR -> CUI : wants to import legacy data

      note right of CUI
        employeeSession has <i><b>center</b></i> obtained 
        during Coordinator login.
      end note

      |||

    CUI -> SESSION : center = getVaccinationCenter()
    activate SESSION
    deactivate SESSION

    CUI -> UI ** : create(center)
    activate UI

      UI -> _APP : app = getInstance()
      activate _APP
      deactivate _APP

      UI -> APP : company = getCompany()
      activate APP
      deactivate APP

      UI -> CTRL ** : create(company, center)
      activate CTRL
        CTRL -> COMPANY : snsUserStore = getSNSUserStore()
        activate COMPANY
        deactivate COMPANY
      deactivate CTRL
      
      COORDINATOR <-- UI : asks to select the file using a file chooser dialog
    deactivate UI

    COORDINATOR -> UI : selects the file
    activate UI
      COORDINATOR <-- UI : asks for confirmation
    deactivate UI
    COORDINATOR -> UI : confirms the file
    activate UI
    
      ' read data

      UI -> CTRL : fileData = read(filepath)
      activate CTRL
        CTRL -> CSVREADER ** : create(filepath)

        CTRL -> CSVREADER : read()
        activate CSVREADER
          CSVREADER -> ICSV ** : newInstance(filepath)
          CSVREADER -> ICSV : read(fileData)
          activate ICSV
          deactivate ICSV
        deactivate CSVREADER

      deactivate CTRL

      ' process data
      UI -> CTRL : legacyDtoList = convert(fileData)
      activate CTRL
        loop for each entry in fileData
          CTRL -> MAPPER : dto = toDto(entry)
          activate MAPPER
            MAPPER -> DTO : create(snsNumber, vaccineName, dose, lotNumber, scheduledDate, arrivalDate, administrationDate, leavingDate)
            activate DTO
            deactivate DTO
          deactivate MAPPER

          CTRL -> LIST_DTOS : add(dto)
          activate LIST_DTOS
          deactivate LIST_DTOS
        end
      deactivate CTRL

      UI -> CTRL : validate(legacy)
      activate CTRL
        loop for each legacyDataDto in legacyDtoList
          CTRL -> DTO : snsNumber = getSNSNumber()
          activate DTO
          deactivate DTO

          CTRL -> SNSSTORE : b = findSNSUserByNumber(snsNumber)
          activate SNSSTORE
          deactivate SNSSTORE
        end
      deactivate CTRL

      UI -> CTRL : sort(legacy)
      activate CTRL
      deactivate CTRL

      ' convert to list dto and send it to ui

      COORDINATOR <-- UI : shows the data and asks if he wants to save it
    deactivate UI

    COORDINATOR -> UI : confirms
    activate UI
      UI -> CTRL : save(legacy)
      activate CTRL
        ' gg
      deactivate CTRL
      COORDINATOR <-- UI : informs operation success
    deactivate UI

  deactivate CUI
deactivate COORDINATOR
@enduml
